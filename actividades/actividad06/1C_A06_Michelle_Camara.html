<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Expresiones Algebraicas</title>

  <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&family=Playwrite+GB+J:ital,wght@0,100..400;1,100..400&display=swap" rel="stylesheet"/>

  <style>
    /* ==================== RESET BÁSICO ==================== */
    *{margin:0;padding:0;box-sizing:border-box;}

    /* ==================== ESTRUCTURA GENERAL ==================== */
    body{
      font-family:"Lexend Deca",sans-serif;
      background-color:#fdfcf9;
      color:#39190F;
      padding:20px;
      line-height:1.6;
      font-size:16px;
    }

    .container{
      max-width: 950px;
      background-color: #fffaf5;
      border: 3px solid #d8b99b;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 6px 6px 0 #b08968;
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 0 auto;
    }

    /* ==================== ENCABEZADOS ==================== */
    .banner{
        text-align: center;
        margin-bottom: 20px;
    }  
    .h1{
        font-family: "Playwrite GB J", cursive;
        align-items: center;
        text-align: center;
        font-size: 26px;
        color: #6f4e37;
        background: #f3e5d0;
        display: inline-block;
        padding: 12px 25px;
        border-radius: 15px;
        border: 2px dashed #b08968;
        box-shadow: 2px 2px 0 #a47551;
    }
    h1{
        animation-duration: 3s;
        animation-name: slidein;
        animation-direction: normal;
        animation-iteration-count: 1;
        animation-timing-function: ease-out;
        display: block;
        margin-left: auto;
        margin-right: auto;
        text-align: center;
    }
    @keyframes slidein {
        from {
        margin-left: auto;
        margin-right: auto;
        transform: translateX(-100%);
        width: 300%;
        }
        to {
        margin-left: auto;
        margin-right: auto;
        transform: translateX(0%);
        width: 100%;
        }
    }

    .meta{
            margin-top: 8px;
            font-size: 14px;
            color: #8c5c42;
            animation-duration: 3s;
            animation-name: slidein;
            animation-direction: normal;
            animation-iteration-count: 1;
            animation-timing-function: ease-out;
    }

    .instructions{
            background-color: #f7ede2;
            border: 2px solid #e3c9b1;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            color: #5c4033;
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid #a47551;
            animation: blink-caret 0.7s step-end 7;
            animation-fill-mode: forwards;
    }

    @keyframes blink-caret {
        from, to { border-color: transparent }
        50% { border-color: #a47551; }
    }
    .instructions strong{
            color: #a47551;
            font-size: 16px;
    }
    .instructions ul{
            margin-top: 8px;
            list-style-type: disc;
            padding-left: 20px;
    }

    /* ==================== BOTONES BASE ==================== */
    .btn-base{
      appearance:none;
      border:none;
      cursor:pointer;
      background:#a47551;
      color:white;
      font-weight:700;
      font-size:15px;
      padding:10px 18px;
      border-radius:24px;
      box-shadow:3px 3px 0 #6f4e37;
      transition:transform .05s, box-shadow .05s, background .2s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
    }
    .btn-base:hover{background:#6f4e37;}
    .btn-base:active{transform:translateY(2px);box-shadow:1px 1px 0 #6f4e37;}

    /* Aplico el mismo estilo a tus clases originales */
    .convert-button,
    .load-button,
    .reset-button,
    .clear-button,
    .export-button,
    .satisfactory-btn,
    .improve-btn,
    .add-pattern-btn{
      background:#a47551;
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:24px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      box-shadow:3px 3px 0 #6f4e37;
      margin-top:10px;
      margin-right:8px;
      transition:transform .05s, box-shadow .05s, background .2s;
    }
    .convert-button:hover,
    .load-button:hover,
    .reset-button:hover,
    .clear-button:hover,
    .export-button:hover,
    .satisfactory-btn:hover,
    .improve-btn:hover,
    .add-pattern-btn:hover{
      background:#6f4e37;
    }
    .convert-button:active,
    .load-button:active,
    .reset-button:active,
    .clear-button:active,
    .export-button:active,
    .satisfactory-btn:active,
    .improve-btn:active,
    .add-pattern-btn:active{
      transform:translateY(2px);
      box-shadow:1px 1px 0 #6f4e37;
    }

    /* ==================== FORM CON DOS COLUMNAS ==================== */    
    .converter-wrapper{
      background:#fffdf9;
      border:2px solid #e3c9b1;
      border-radius:15px;
      padding:20px;
      box-shadow:3px 3px 0 #b08968;
    }

    .converter-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
    }

    @keyframes fadein {
        from { opacity: 0; }
        to   { opacity: 1; }
    }
    
    .column{
      background:#fffdf9;
      border:2px solid #e3c9b1;
      border-radius:15px;
      padding:18px;
      box-shadow:3px 3px 0 #d1a280;
      opacity:0;
      animation:fadein 1.2s ease-in forwards;
    }

    .column h2{
      font-size:16px;
      margin-bottom:10px;
      color:#6f4e37;
      border-bottom:1px dashed #d8b99b;
      padding-bottom:6px;
      text-align:center;
    }

    .input-group{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:6px;
    }
    .input-group label{
      font-weight:600;
      color:#6f4e37;
    }

    textarea{
      width:100%;
      min-height:100px;
      padding:10px 12px;
      border:2px solid #d8b99b;
      border-radius:10px;
      background:#fdfaf6;
      color:#39190F;
      font-family:"Courier New",monospace;
      font-size:15px;
      transition:border-color .2s, box-shadow .2s;
      resize:vertical;
    }
    textarea:focus{
      outline:none;
      border-color:#a47551;
      box-shadow:inset 2px 2px 0 #e6d5c6;
    }
    textarea::placeholder{color:#9c7f6b;}

    .result-output{
      margin-top:10px;
      background:#f9f3eb;
      padding:10px 12px;
      border-radius:10px;
      font-family:"Courier New",monospace;
      font-size:14px;
      color:#39190F;
      font-weight:bold;
      border-left:6px solid #6f4e37;
      box-shadow:inset 2px 2px 0 #d1a280;
      min-height:50px;
      white-space:pre-wrap;
    }

    .evaluation-buttons{
      margin-top:8px;
    }

    /* ==================== SECCIONES EXTRA ==================== */
    .section-card{
      background:#fffdf9;
      border:2px solid #e3c9b1;
      border-radius:15px;
      padding:18px;
      box-shadow:3px 3px 0 #b08968;
    }
    .section-card h2{
      font-size:16px;
      margin-bottom:10px;
      color:#6f4e37;
      border-bottom:1px dashed #d8b99b;
      padding-bottom:6px;
    }

    .json-loader{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top:8px;
    }

    .json-loader button {
      flex-shrink: 0;
    }

    .button-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .file-input-wrapper{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    #json-file-input{
      padding:6px;
    }

    .file-name{
      font-size:14px;
      color:#6b4b39;
    }

    .info-cards{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:12px;
      margin-top:10px;
    }
    .info-card{
      background:#f7ede2;
      border:1px solid #e3c9b1;
      border-radius:12px;
      padding:12px;
      text-align:center;
    }
    .metric-number{
      font-size:1.4rem;
      font-weight:700;
      color:#6f4e37;
    }
    .metric-label{
      font-size:12px;
      color:#7a5a46;
    }

    .history-controls{
      margin-bottom:10px;
    }
    .history-list{
      max-height:260px;
      overflow-y:auto;
      padding-right:6px;
    }
    .history-item{
      background:#f7ede2;
      padding:10px 12px;
      border-radius:10px;
      margin-bottom:10px;
      border-left:6px solid #a47551;
      font-size:14px;
    }
    .history-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
      font-weight:600;
      color:#6f4e37;
    }
    .history-timestamp{
      font-size:12px;
      color:#7a5a46;
    }
    .no-history{
      font-size:14px;
      color:#7a5a46;
    }

    .back-btn {
        background: #8c5c42;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 30px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 3px 3px 0 #6f4e37;
        display: block;
        margin: 20px auto;
        text-decoration: none;
        text-align: center;
        width: fit-content;
        max-width: 950px;
        opacity: 0;
        animation: fadein 1.2s ease-in forwards;
        animation-delay: 0.3s;
    }
    .back-btn:hover { background: #39190F; box-shadow: 2px 2px 0 #6f4e37; }
    .back-btn:active { box-shadow: none; transform: translateY(2px); }

    @media(max-width:768px){
      .converter-grid{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Banner -->
    <div class="banner">
      <h1><span class="h1">Calculadora de Expresiones Algebraicas</span></h1>
      <p class="meta">
        Tecnológico de Software · Fundamentos de Álgebra · Prof. Jorge Javier Pedrozo Romero · 1°C · Cuatrimestre 1 · Michelle Cámara González
      </p>
    </div>

    <!-- Instrucciones -->
    <div class="instructions">
      <strong>✦ Instrucciones: </strong>
      <ul>
        <li>
          En la columna de <em>Lenguaje Natural</em> escribe frases como
          “La suma de a y b”, “El cuadrado de la diferencia de x y y”, etc.
        </li>
        <li>
          En la columna de <em>Expresión Algebraica</em> escribe expresiones como
          <code>a^2 + b^2</code>, <code>(x - y)^2</code>, <code>√a</code>, etc.
        </li>
        <li>
          Puedes cargar un archivo JSON con más patrones o usar los patrones por defecto.
        </li>
        <li>
          Marca si el resultado es satisfactorio o si necesita mejora, y agrega nuevos patrones personalizados.
        </li>
      </ul>
    </div>

    <!-- Conversor principal -->
    <section class="converter-wrapper">
      <div class="converter-grid">
        <!-- Columna izquierda: Lenguaje Natural -->
        <div class="column natural-column">
          <h2>Lenguaje Natural</h2>
          <div class="input-group">
            <label for="natural-input">Escribe en palabras tu expresión matemática:</label>
            <textarea id="natural-input" placeholder="Ejemplo: La suma de a y b"></textarea>
          </div>
          <button id="convert-to-algebraic-btn" class="convert-button">
            Convertir a Expresión Algebraica
          </button>
          <div id="natural-result" class="result-section" style="display:none;">
            <div class="result-content">
              <h4>Resultado:</h4>
              <div id="natural-output" class="result-output"></div>
            </div>
            <div class="evaluation-buttons">
              <button id="natural-satisfactory-btn" class="satisfactory-btn">Resultado Satisfactorio</button>
              <button id="natural-improve-btn" class="improve-btn">Necesita Mejora</button>
              <button id="natural-add-pattern-btn" class="add-pattern-btn">Agregar Patrón</button>
            </div>
          </div>
        </div>

        <!-- Columna derecha: Expresión Algebraica -->
        <div class="column algebraic-column">
          <h2>Expresión Algebraica</h2>
          <div class="input-group">
            <label for="algebraic-input">Escribe tu expresión matemática:</label>
            <textarea id="algebraic-input" placeholder="Ejemplo: a^2 + b^2"></textarea>
          </div>
          <button id="convert-to-natural-btn" class="convert-button">
            Convertir a Lenguaje Natural
          </button>
          <div id="algebraic-result" class="result-section" style="display:none;">
            <div class="result-content">
              <h4>Resultado:</h4>
              <div id="algebraic-output" class="result-output"></div>
            </div>
            <div class="evaluation-buttons">
              <button id="algebraic-satisfactory-btn" class="satisfactory-btn">Resultado Satisfactorio</button>
              <button id="algebraic-improve-btn" class="improve-btn">Necesita Mejora</button>
              <button id="algebraic-add-pattern-btn" class="add-pattern-btn">Agregar Patrón</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Base de datos de patrones -->
    <section class="section-card">
      <h2>Base de Datos de Patrones</h2>
      <div class="json-loader">
        <div class="file-input-wrapper">
          <input type="file" id="json-file-input" accept=".json"/>
          <span id="file-name" class="file-name">Ningún archivo seleccionado</span>
        </div>
        <div class="button-group">
          <button id="load-json-btn" class="load-button" disabled>Cargar Patrones</button>
          <button id="reset-json-btn" class="reset-button">Usar Patrones por Defecto</button>
        </div>
      </div>
    </section>

    <!-- Información del sistema -->
    <section class="section-card">
      <h2>Información del Sistema</h2>
      <div class="info-cards">
        <div class="info-card">
          <h3>Patrones Cargados</h3>
          <div class="metric">
            <span class="metric-number" id="total-patterns">0</span>
            <div class="metric-label">expresiones disponibles</div>
          </div>
        </div>
        <div class="info-card">
          <h3>Archivo JSON</h3>
          <div class="metric">
            <span class="metric-number" id="file-size">0 KB</span>
            <div class="metric-label">tamaño del archivo</div>
          </div>
        </div>
        <div class="info-card">
          <h3>Conversiones</h3>
          <div class="metric">
            <span class="metric-number" id="conversions-count">0</span>
            <div class="metric-label">conversiones realizadas</div>
          </div>
        </div>
        <div class="info-card">
          <h3>Tasa de Satisfacción</h3>
          <div class="metric">
            <span class="metric-number" id="satisfaction-rate">0%</span>
            <div class="metric-label">conversiones satisfactorias</div>
          </div>
        </div>
        <div class="info-card">
          <h3>Última Actualización</h3>
          <div class="metric">
            <span class="metric-number" id="last-update">--</span>
            <div class="metric-label">patrones modificados</div>
          </div>
        </div>
        <div class="info-card">
          <h3>Complejidad Promedio</h3>
          <div class="metric">
            <span class="metric-number" id="avg-complexity">0</span>
            <div class="metric-label">palabras por expresión</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Historial -->
    <section class="section-card">
      <h2>Historial de Conversiones</h2>
      <div class="history-controls">
        <button id="clear-history-btn" class="clear-button">Limpiar Historial</button>
        <button id="export-history-btn" class="export-button">Exportar Historial</button>
      </div>
      <div id="conversion-history" class="history-list">
        <p class="no-history">No hay conversiones realizadas aún</p>
      </div>
    </section>

    </div>

    <a href="../../index.html" class="back-btn">← Regresar al Portafolio</a>

<script>
    // Variables globales
let patternsData = null;
let conversionHistory = [];
let stats = {
    totalConversions: 0,
    satisfactoryConversions: 0,
    totalPatterns: 0,
    fileSize: 0,
    lastUpdate: null
};

// Patrones por defecto para comenzar
const defaultPatterns = {
    "patterns": [
        {
            "id": 1,
            "natural": "La suma de {var1} y {var2}",
            "algebraic": "{var1} + {var2}",
            "category": "operaciones_basicas"
        },
        {
            "id": 2,
            "natural": "La resta de {var1} y {var2}",
            "algebraic": "{var1} - {var2}",
            "category": "operaciones_basicas"
        },
        {
            "id": 3,
            "natural": "El producto de {var1} por {var2}",
            "algebraic": "{var1} × {var2}",
            "category": "operaciones_basicas"
        },
        {
            "id": 4,
            "natural": "El cociente de {var1} sobre {var2}",
            "algebraic": "{var1} ÷ {var2}",
            "category": "operaciones_basicas"
        },
		{
            "id": 5,
            "natural": "La suma de los cuadrados de {var1} y {var2}",
            "algebraic": "{var1}^2 + {var2}^2",
            "category": "combinadas"
        },
        {
            "id": 6,
            "natural": "La diferencia de {var1} y {var2}",
            "algebraic": "{var1} - {var2}",
            "category": "operaciones_basicas"
        },
        {
            "id": 7,
            "natural": "El cuadrado de {var1}",
            "algebraic": "{var1}^2",
            "category": "potencias"
        },
        {
            "id": 8,
            "natural": "La diferencia de los cuadrados de {var1} y {var2}",
            "algebraic": "{var1}^2 - {var2}^2",
            "category": "combinadas"
        },
        {
            "id": 9,
            "natural": "La suma de {var1} y {var2} al cuadrado",
            "algebraic": "({var1} + {var2})^2",
            "category": "combinadas"
        },
        {
            "id": 10,
            "natural": "El producto de {var1} y {var2} al cuadrado",
            "algebraic": "{var1}^2 × {var2}^2",
            "category": "combinadas"
        },       
        {
            "id": 11,
            "natural": "La suma de {var1}, {var2} y {var3}",
            "algebraic": "{var1} + {var2} + {var3}",
            "category": "operaciones_basicas"
        },
        {
            "id": 12,
            "natural": "El producto de {var1}, {var2} y {var3}",
            "algebraic": "{var1} × {var2} × {var3}",
            "category": "operaciones_basicas"
        },
        {
            "id": 13,
            "natural": "El cuadrado de la suma de {var1} y {var2}",
            "algebraic": "({var1} + {var2})^2",
            "category": "combinadas"
        },
        {
            "id": 14,
            "natural": "El cubo de {var1}",
            "algebraic": "{var1}^3",
            "category": "potencias"
        },
        {
            "id": 15,
            "natural": "La raíz cuadrada de {var1}",
            "algebraic": "√{var1}",
            "category": "raices"
        },
        {
            "id": 16,
            "natural": "La raíz cúbica de {var1}",
            "algebraic": "³√{var1}",
            "category": "raices"
        },
        {
            "id": 17,
            "natural": "El cuadrado de la diferencia de {var1} y {var2}",
            "algebraic": "({var1} - {var2})^2",
            "category": "combinadas"
        },
        {
            "id": 18,
            "natural": "El producto de la suma de {var1} y {var2} por {var3}",
            "algebraic": "({var1} + {var2}) × {var3}",
            "category": "combinadas"
        },
        {
            "id": 19,
            "natural": "El cociente de la diferencia de {var1} y {var2} sobre {var3}",
            "algebraic": "({var1} - {var2}) ÷ {var3}",
            "category": "combinadas"
        },
        {
            "id": 20,
            "natural": "La suma de los cubos de {var1} y {var2}",
            "algebraic": "{var1}^3 + {var2}^3",
            "category": "combinadas"
        }
    ]
};

// InicializaciÃ³n cuando se carga la pÃ¡gina
document.addEventListener('DOMContentLoaded', function() {
    // Cargar patrones por defecto
    loadPatterns(defaultPatterns);
    
    // Configurar event listeners
    setupEventListeners();
    
    // Actualizar mÃ©tricas iniciales
    updateMetrics();
});

// Configurar todos los event listeners
function setupEventListeners() {
    // Botones de conversiÃ³n
    document.getElementById('convert-to-algebraic-btn').addEventListener('click', () => {
        convertNaturalToAlgebraic();
    });
    
    document.getElementById('convert-to-natural-btn').addEventListener('click', () => {
        convertAlgebraicToNatural();
    });
    
    // Botones de evaluaciÃ³n - Columna Natural
    document.getElementById('natural-satisfactory-btn').addEventListener('click', () => {
        markAsSatisfactory('natural');
    });
    
    document.getElementById('natural-improve-btn').addEventListener('click', () => {
        markForImprovement('natural');
    });
    
    document.getElementById('natural-add-pattern-btn').addEventListener('click', () => {
        showAddPatternDialog('natural');
    });
    
    // Botones de evaluaciÃ³n - Columna Algebraica
    document.getElementById('algebraic-satisfactory-btn').addEventListener('click', () => {
        markAsSatisfactory('algebraic');
    });
    
    document.getElementById('algebraic-improve-btn').addEventListener('click', () => {
        markForImprovement('algebraic');
    });
    
    document.getElementById('algebraic-add-pattern-btn').addEventListener('click', () => {
        showAddPatternDialog('algebraic');
    });
    
    // Manejo de archivos JSON
    document.getElementById('json-file-input').addEventListener('change', handleFileSelection);
    document.getElementById('load-json-btn').addEventListener('click', loadJSONFile);
    document.getElementById('reset-json-btn').addEventListener('click', resetToDefault);
    
    // Historial
    document.getElementById('clear-history-btn').addEventListener('click', clearHistory);
    document.getElementById('export-history-btn').addEventListener('click', exportHistory);
}

// FunciÃ³n para convertir lenguaje natural a algebraico
function convertNaturalToAlgebraic() {
    const input = document.getElementById('natural-input').value.trim();
    if (!input) {
        alert('Por favor, ingresa una expresión en lenguaje natural');
        return;
    }
    
    const result = processNaturalToAlgebraic(input);
    displayResult('natural', input, result);
    
    // Actualizar estadÃ­sticas
    stats.totalConversions++;
    addToHistory('natural-to-algebraic', input, result);
    updateMetrics();
}

// FunciÃ³n para convertir algebraico a lenguaje natural
function convertAlgebraicToNatural() {
    const input = document.getElementById('algebraic-input').value.trim();
    if (!input) {
        alert('Por favor, ingresa una expresión algebraica');
        return;
    }
    
    const result = processAlgebraicToNatural(input);
    displayResult('algebraic', input, result);
    
    // Actualizar estadÃ­sticas
    stats.totalConversions++;
    addToHistory('algebraic-to-natural', input, result);
    updateMetrics();
}

// Procesar conversiÃ³n de natural a algebraico
function processNaturalToAlgebraic(input) {
    if (!patternsData || !patternsData.patterns) {
        return "Error: No hay patrones cargados";
    }
    
    const normalizedInput = input.toLowerCase();
    
    // Buscar patrones que coincidan
    for (let pattern of patternsData.patterns) {
        const match = matchNaturalPattern(normalizedInput, pattern.natural);
        if (match.isMatch) {
            return substituteVariables(pattern.algebraic, match.variables);
        }
    }
    
    return "No se encontró un patrón coincidente. Considera agregar este caso a los patrones.";
}

// Procesar conversiÃ³n de algebraico a natural
function processAlgebraicToNatural(input) {
    if (!patternsData || !patternsData.patterns) {
        return "Error: No hay patrones cargados";
    }
    
    const normalizedInput = normalizeAlgebraicExpression(input);
    
    // Buscar patrones que coincidan
    for (let pattern of patternsData.patterns) {
        const match = matchAlgebraicPattern(normalizedInput, pattern.algebraic);
        if (match.isMatch) {
            return substituteVariables(pattern.natural, match.variables);
        }
    }
    
    return "No se encontró un patrón coincidente. Considera agregar este caso a los patrones.";
}

// FunciÃ³n para hacer coincidir patrones de lenguaje natural

function matchNaturalPattern(input, pattern) {
    // Convertir patrÃ³n a regex
    let regex = pattern.toLowerCase();
    const variables = {};
    let varCounter = 0;
    
    // Reemplazar variables con grupos de captura
    regex = regex.replace(/\{(\w+)\}/g, (match, varName) => {
        variables[varName] = varCounter++;
        return '([a-zA-Z0-9_]+)';
    });
    
    // Hacer que los espacios sean opcionales y flexibles
    regex = regex.replace(/\s+/g, '\\s*');
    regex = '^\\s*' + regex + '\\s*$';
    
    const regexPattern = new RegExp(regex);
    const match = input.match(regexPattern);
    
    if (match) {
        const extractedVars = {};
        for (let [varName, index] of Object.entries(variables)) {
            extractedVars[varName] = match[index + 1];
        }
        return { isMatch: true, variables: extractedVars };
    }
    
    return { isMatch: false, variables: {} };
}

// Auxiliar: escapa todo lo especial en regex excepto { }
function escapeRegexExceptBraces(str) {
  return str.replace(/[-\/\\^$*+?.()|[\]]/g, '\\$&');
}


function matchAlgebraicPattern(input, pattern) {
  const normalizedInput = normalizeAlgebraicExpression(input);
  const normalizedPattern = normalizeAlgebraicExpression(pattern);

  // Primero escapamos todo lo especial (excepto { })
  let regex = escapeRegexExceptBraces(normalizedPattern);

  // Luego reemplazamos los placeholders por grupos de captura
  const variables = {};
  let counter = 0;
  regex = regex.replace(/\{(\w+)\}/g, (_, name) => {
    variables[name] = counter++;
    // Acepta identificadores tipo a, a1, var_2 (ajústalo si quieres más laxo)
    return '([a-zA-Z][a-zA-Z0-9_]*)';
  });

  // Delimitadores de inicio y fin
  regex = '^' + regex + '$';

  const re = new RegExp(regex);
  const match = normalizedInput.match(re);

  if (!match) return { isMatch: false, variables: {} };

  const extracted = {};
  for (const [name, idx] of Object.entries(variables)) {
    extracted[name] = match[idx + 1];
  }
  return { isMatch: true, variables: extracted };
}
/*
function matchAlgebraicPattern(input, pattern) {
    let normalizedInput = normalizeAlgebraicExpression(input);
    let normalizedPattern = normalizeAlgebraicExpression(pattern);

    console.log('=== DEBUGGING MATCH ===');
    console.log('Pattern original:', pattern);
    console.log('Pattern normalizado:', normalizedPattern);
    console.log('Input original:', input);
    console.log('Input normalizado:', normalizedInput);

    const variables = {};
    let varCounter = 0;

    // Reemplazar variables con grupos de captura
    let regex = normalizedPattern.replace(/\{(\w+)\}/g, (match, varName) => {
        variables[varName] = varCounter++;
        console.log(`Variable encontrada: ${varName} en posición ${varCounter-1}`);
        return '([a-zA-Z0-9_]+)';
    });

    // Solo escapar caracteres especiales
    regex = regex.replace(/[\+\-\*\^]/g, '\\$&');
    regex = '^\\s*' + regex + '\\s*$';

    console.log('Regex final:', regex);
    console.log('Variables mapeadas:', variables);

    const regexPattern = new RegExp(regex);
    const match = normalizedInput.match(regexPattern);

    console.log('Match result:', match);
    console.log('=== END DEBUG ===');

    if (match) {
        const extractedVars = {};
        for (let [varName, index] of Object.entries(variables)) {
            extractedVars[varName] = match[index + 1];
        }
        return { isMatch: true, variables: extractedVars };
    }

    return { isMatch: false, variables: {} };
}
*/
// Normalizar expresiones algebraicas
function normalizeAlgebraicExpression(expr) {
    return expr
        .replace(/\s+/g, '') // Elimina espacios
        .replace(/²/g, '^2')
        .replace(/³/g, '^3')
        .replace(/\*/g, '×')
        .replace(/\//g, '÷')
        .toLowerCase();
}

// Sustituir variables en el patrÃ³n
function substituteVariables(template, variables) {
    let result = template;
    for (let [varName, value] of Object.entries(variables)) {
        const regex = new RegExp(`\\{${varName}\\}`, 'g');
        result = result.replace(regex, value);
    }
    return result;
}

// Mostrar resultado en la interfaz
function displayResult(column, input, result) {
    const resultSection = document.getElementById(`${column}-result`);
    const outputElement = document.getElementById(`${column}-output`);
    
    outputElement.textContent = result;
    resultSection.style.display = 'block';
}

// Marcar como satisfactorio
function markAsSatisfactory(column) {
    stats.satisfactoryConversions++;
    updateMetrics();
    
    // Feedback visual
    showFeedback(`Marcado como satisfactorio`, 'success');
    
    // Ocultar la secciÃ³n de resultado despuÃ©s de un tiempo
    setTimeout(() => {
        document.getElementById(`${column}-result`).style.display = 'none';
    }, 2000);
}

// Marcar para mejora
function markForImprovement(column) {
    showFeedback('Marcado para mejora. Considera agregar un nuevo patrón.', 'warning');
}

// Mostrar diÃ¡logo para agregar patrÃ³n
function showAddPatternDialog(column) {
    const input = document.getElementById(`${column === 'natural' ? 'natural' : 'algebraic'}-input`).value;
    const output = document.getElementById(`${column}-output`).textContent;
    
    const naturalText = column === 'natural' ? input : output;
    const algebraicText = column === 'natural' ? output : input;
    
    const newNatural = prompt('Expresión en lenguaje natural:', naturalText);
    if (!newNatural) return;
    
    const newAlgebraic = prompt('Expresión algebraica:', algebraicText);
    if (!newAlgebraic) return;
    
    const category = prompt('Categoría­a (opcional):', 'personalizado') || 'personalizado';
    
    addNewPattern(newNatural, newAlgebraic, category);
}

// Agregar nuevo patrÃ³n
function addNewPattern(natural, algebraic, category = 'personalizado') {
    if (!patternsData) {
        patternsData = { patterns: [] };
    }
    
    const newId = Math.max(...patternsData.patterns.map(p => p.id || 0), 0) + 1;
    const newPattern = {
        id: newId,
        natural: natural,
        algebraic: algebraic,
        category: category
    };
    
    patternsData.patterns.push(newPattern);
    stats.totalPatterns = patternsData.patterns.length;
    updateMetrics();
    
    showFeedback(`Nuevo patrón agregado: "${natural}" - "${algebraic}"`, 'success');
}

// Cargar patrones
function loadPatterns(data) {
    patternsData = data;
    stats.totalPatterns = data.patterns ? data.patterns.length : 0;
    stats.lastUpdate = new Date().toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
    updateMetrics();
}

// Manejar selecciÃ³n de archivo
function handleFileSelection() {
    const fileInput = document.getElementById('json-file-input');
    const fileName = document.getElementById('file-name');
    const loadButton = document.getElementById('load-json-btn');
    
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileName.textContent = file.name;
        stats.fileSize = Math.round(file.size / 1024);
        loadButton.disabled = false;
    } else {
        fileName.textContent = 'Ningún archivo seleccionado';
        stats.fileSize = 0;
        loadButton.disabled = true;
    }
    updateMetrics();
}

// Cargar archivo JSON
function loadJSONFile() {
    const fileInput = document.getElementById('json-file-input');
    if (fileInput.files.length === 0) {
        alert('Por favor, selecciona un archivo JSON');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const jsonData = JSON.parse(e.target.result);
            
            // Validar estructura del JSON
            if (!jsonData.patterns || !Array.isArray(jsonData.patterns)) {
                throw new Error('El archivo JSON debe tener una propiedad "patterns" que sea un array');
            }
            
            loadPatterns(jsonData);
            showFeedback(`Archivo cargado exitosamente: ${file.name}`, 'success');
            
        } catch (error) {
            alert(`Error al cargar el archivo: ${error.message}`);
        }
    };
    
    reader.readAsText(file);
}

// Resetear a patrones por defecto
function resetToDefault() {
    if (confirm('¿Estás seguro de que quieres resetear a los patrones por defecto?')) {
        loadPatterns(defaultPatterns);
        stats.fileSize = 0;
        document.getElementById('file-name').textContent = 'Ningún archivo seleccionado';
        document.getElementById('json-file-input').value = '';
        showFeedback('Patrones reseteados a valores por defecto', 'info');
    }
}

// Agregar al historial
function addToHistory(type, input, output) {
    const historyItem = {
        timestamp: new Date().toLocaleString('es-ES'),
        type: type,
        input: input,
        output: output
    };
    
    conversionHistory.unshift(historyItem); // Agregar al inicio
    if (conversionHistory.length > 50) { // Limitar historial
        conversionHistory.pop();
    }
    
    updateHistoryDisplay();
}

// Actualizar visualizaciÃ³n del historial
function updateHistoryDisplay() {
    const historyContainer = document.getElementById('conversion-history');
    
    if (conversionHistory.length === 0) {
        historyContainer.innerHTML = '<p class="no-history">No hay conversiones realizadas aún</p>';
        return;
    }
    
    const historyHTML = conversionHistory.map(item => `
        <div class="history-item">
            <div class="history-header">
                <span class="history-type">${item.type === 'natural-to-algebraic' ? 'Natural a Algebraico' : 'Algebraico a Natural'}</span>
                <span class="history-timestamp">${item.timestamp}</span>
            </div>
            <div class="history-content">
                <div><strong>Entrada:</strong> ${item.input}</div>
                <div><strong>Resultado:</strong> ${item.output}</div>
            </div>
        </div>
    `).join('');
    
    historyContainer.innerHTML = historyHTML;
}

// Limpiar historial
function clearHistory() {
    if (confirm('¿Estás seguro de que quieres limpiar el historial?')) {
        conversionHistory = [];
        updateHistoryDisplay();
        showFeedback('Historial limpiado', 'info');
    }
}

// Exportar historial
function exportHistory() {
    if (conversionHistory.length === 0) {
        alert('No hay historial para exportar');
        return;
    }
    
    const dataStr = JSON.stringify(conversionHistory, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `historial_conversiones_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showFeedback('Historial exportado exitosamente', 'success');
}

// Actualizar mÃ©tricas en la interfaz
function updateMetrics() {
    document.getElementById('total-patterns').textContent = stats.totalPatterns;
    document.getElementById('file-size').textContent = stats.fileSize > 0 ? `${stats.fileSize} KB` : '0 KB';
    document.getElementById('conversions-count').textContent = stats.totalConversions;
    
    // Calcular tasa de satisfacciÃ³n
    const satisfactionRate = stats.totalConversions > 0 
        ? Math.round((stats.satisfactoryConversions / stats.totalConversions) * 100)
        : 0;
    document.getElementById('satisfaction-rate').textContent = `${satisfactionRate}%`;
    
    document.getElementById('last-update').textContent = stats.lastUpdate || '--';
    
    // Calcular complejidad promedio
    const avgComplexity = calculateAverageComplexity();
    document.getElementById('avg-complexity').textContent = avgComplexity;
}

// Calcular complejidad promedio
function calculateAverageComplexity() {
    if (!patternsData || !patternsData.patterns || patternsData.patterns.length === 0) {
        return 0;
    }
    
    const totalWords = patternsData.patterns.reduce((sum, pattern) => {
        const wordCount = pattern.natural.split(' ').length;
        return sum + wordCount;
    }, 0);
    
    return Math.round(totalWords / patternsData.patterns.length);
}

// Mostrar feedback al usuario
function showFeedback(message, type = 'info') {
    // Crear elemento de feedback si no existe
    let feedbackElement = document.getElementById('feedback-message');
    if (!feedbackElement) {
        feedbackElement = document.createElement('div');
        feedbackElement.id = 'feedback-message';
        feedbackElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transition: opacity 0.3s ease;
        `;
        document.body.appendChild(feedbackElement);
    }
    
    // Configurar estilos segÃºn el tipo
    const colors = {
        'success': '#10b981',
        'error': '#ef4444',
        'warning': '#f59e0b',
        'info': '#3b82f6'
    };
    
    feedbackElement.style.backgroundColor = colors[type] || colors['info'];
    feedbackElement.textContent = message;
    feedbackElement.style.opacity = '1';
    
    // Ocultar despuÃ©s de 3 segundos
    setTimeout(() => {
        feedbackElement.style.opacity = '0';
    }, 3000);
}
</script>
</body>
</html>
